<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f3f6fb;
  padding:20px;
}

h1{text-align:center}

/* ===== LAYOUT ===== */
.container{
  display:flex;
  gap:24px;
  flex-wrap:wrap;
}

.box{
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  flex:1;
  min-width:320px;
}

/* ===== LOGIN ===== */
.role-box{text-align:center}
.role-box button{font-size:22px;padding:18px;margin-top:16px}

/* ===== INPUT ===== */
select,input,textarea{
  width:100%;
  font-size:18px;
  padding:12px;
  margin-bottom:14px;
  border-radius:10px;
  border:2px solid #ddd;
}

.qty-input{
  width:80px;
  text-align:center;
  font-weight:bold;
}

.note-textarea{resize:none}

/* ===== BUTTON ===== */
button{
  border:none;
  border-radius:10px;
  background:#007bff;
  color:#fff;
  cursor:pointer;
}

button:hover{background:#0056b3}

.btn-center{text-align:center}

.btn-compact{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 20px;
  font-size:15px;
  font-weight:600;
  border-radius:10px;
  background:#0d6efd;
  color:#fff;
  margin-top:10px;
}

.btn-compact:hover{background:#0b5ed7}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse}

th{
  background:#007bff;
  color:white;
  padding:12px;
}

td{
  padding:12px;
  text-align:center;
  border-bottom:1px solid #eee;
}

.temp-import{background:#e8fff1}
.temp-export{background:#ffecec}

/* ===== HISTORY ===== */
.history-group{
  background:#f0f4ff;
  cursor:pointer;
  font-weight:bold;
}

.history-group:hover{background:#dbe4ff}

/* ===== HISTORY DETAIL ===== */
.history-detail{
  background:#f5f6f8;
  padding:16px;
  font-size:14px;
  border-left:5px solid #007bff;
  animation:fadeIn .25s ease;
}

.history-detail table{
  width:92%;
  margin-left:24px;
  background:#f9fafb;
  border-radius:8px;
}

.history-detail th{
  background:#e9ecef;
  color:#555;
  font-size:12px;
  padding:8px;
}

.history-detail td{
  font-size:13px;
  padding:8px;
}

/* highlight */
.changed{
  background:#fff9db !important;
  border-color:#ffd43b !important;
}

/* edit button */
.edit-actions{text-align:right;padding-top:8px}

.btn-edit{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 14px;
  font-size:13px;
  background:#f1f3f5;
  color:#555;
  border:1px solid #ced4da;
  border-radius:6px;
}

.btn-edit:hover{background:#e9ecef;color:#222}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(-5px)}
  to{opacity:1;transform:translateY(0)}
}

.hidden{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- ===== LOGIN ===== -->
<div id="roleSelect" class="container">
  <div class="box role-box">
    <h2>ADMIN</h2>
    <input id="adminPass" type="password" placeholder="M·∫≠t kh·∫©u admin">
    <button class="btn-compact" onclick="loginAdmin()">ƒêƒÇNG NH·∫¨P</button>
  </div>

  <div class="box role-box">
    <h2>USER</h2>
    <p>Xem v·∫≠t t∆∞ & l·ªãch s·ª≠</p>
    <button class="btn-compact" onclick="loginUser()">V√ÄO XEM</button>
  </div>
</div>

<!-- ===== ADMIN ===== -->
<div id="adminArea" class="hidden">
<div class="container">

<div class="box">
<h3>üîÑ NH·∫¨P / XU·∫§T</h3>
<select id="itemSelect"></select>
<select id="sign">
<option value="+">‚ûï NH·∫¨P</option>
<option value="-">‚ûñ XU·∫§T</option>
</select>
<input id="qty" type="number" class="qty-input" placeholder="SL">
<textarea id="noteLine" placeholder="Ghi ch√∫"></textarea>
<div class="btn-center">
<button class="btn-compact" onclick="addTemp()">‚ûï Th√™m v√†o DS t·∫°m</button>
</div>
</div>

<div class="box">
<h3>üìã DANH S√ÅCH T·∫†M</h3>
<table>
<thead>
<tr><th>V·∫≠t t∆∞</th><th>Nh·∫≠p/Xu·∫•t</th><th>Ghi ch√∫</th><th>X√≥a</th></tr>
</thead>
<tbody id="tempTable"></tbody>
</table>
<textarea id="logNote" placeholder="Ghi ch√∫ chung"></textarea>
<div class="btn-center">
<button class="btn-compact" onclick="saveToSheet()">üíæ L∆∞u v√†o kho</button>
</div>
</div>

</div>
</div>

<!-- ===== VIEW ===== -->
<div id="viewArea" class="hidden">
<h3>V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>
<table>
<thead><tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
<tbody id="mainTable"></tbody>
</table>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
<thead><tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr></thead>
<tbody id="historyTable"></tbody>
</table>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxduYVlwx2reJLXTD-mvCHyKshrXZvHWxkK-gWcf6Iy74MRhheN4TwX2XLUzDD6rhMeMQ/exec";

let inventory=[],temp=[],history=[],isAdmin=false;

/* ===== LOGIN ===== */
function loginAdmin(){
  if(adminPass.value!=="1234") return alert("Sai m·∫≠t kh·∫©u");
  isAdmin=true;
  roleSelect.classList.add("hidden");
  adminArea.classList.remove("hidden");
  viewArea.classList.remove("hidden");
  init();
}

function loginUser(){
  isAdmin=false;
  roleSelect.classList.add("hidden");
  viewArea.classList.remove("hidden");
  init();
}

/* ===== INIT ===== */
async function init(){
  await loadInventory();
  await loadHistory();
}

/* ===== INVENTORY ===== */
function renderInventory(){
  if(isAdmin){
    itemSelect.innerHTML="";
    inventory.forEach((i,idx)=>{
      itemSelect.innerHTML+=`<option value="${idx}">${i.name}</option>`;
    });
  }
  mainTable.innerHTML="";
  inventory.forEach(i=>{
    mainTable.innerHTML+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

/* ===== TEMP ===== */
function renderTemp(){
  if(!isAdmin) return;
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
    <tr class="${t.sign==='+'?'temp-import':'temp-export'}">
      <td>${t.name}</td>
      <td>${t.sign==='+'?'NH·∫¨P':'XU·∫§T'}<br><b>${t.qty}</b></td>
      <td>${t.note||''}</td>
      <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
    </tr>`;
  });
}

/* ===== HISTORY ===== */
function renderHistory(){
  historyTable.innerHTML="";
  history.forEach((g,idx)=>{
    historyTable.innerHTML+=`
    <tr class="history-group" onclick="toggle(${idx})">
      <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
      <td>${g.items[0].type}</td>
      <td>${g.items.map(i=>i.name+": "+i.qty).join(" | ")}</td>
    </tr>

    <tr id="h${idx}" style="display:none">
      <td colspan="3" class="history-detail">
        <table>
          <tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th><th>Ghi ch√∫</th></tr>

          ${g.items.map((it,j)=>`
          <tr>
            <td>${it.name}</td>
            <td>
              ${
                isAdmin
                ? `<input class="qty-input" value="${it.qty}"
                   onchange="this.classList.add('changed');history[${idx}].items[${j}].qty=+this.value">`
                : `<b>${it.qty}</b>`
              }
            </td>
            <td>
              ${
                isAdmin
                ? `<textarea onchange="this.classList.add('changed');history[${idx}].items[${j}].note=this.value">${it.note||""}</textarea>`
                : (it.note||"")
              }
            </td>
          </tr>`).join("")}

          ${
            isAdmin
            ? `<tr>
                <td colspan="3" class="edit-actions">
                  <button class="btn-edit" onclick="saveHistory(${idx})">üíæ L∆∞u ch·ªânh s·ª≠a</button>
                </td>
              </tr>`
            : ``
          }
        </table>
      </td>
    </tr>`;
  });
}

function toggle(i){
  const el=document.getElementById("h"+i);
  el.style.display=el.style.display==="none"?"":"none";
}

/* ===== LOAD ===== */
async function loadInventory(){
  inventory=await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}
async function loadHistory(){
  history=await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

/* ===== ADMIN ACTION ===== */
function addTemp(){
  temp.push({
    name:inventory[itemSelect.value].name,
    sign:sign.value,
    qty:+qty.value,
    note:noteLine.value
  });
  qty.value="";noteLine.value="";
  renderTemp();
}

async function saveToSheet(){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({items:temp,note:logNote.value})
  });
  temp=[];logNote.value="";
  await init();
  alert("ƒê√£ l∆∞u");
}

async function saveHistory(i){
  if(!confirm("L∆∞u ch·ªânh s·ª≠a?"))return;
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"editHistory",group:history[i]})
  });
  await init();
  alert("ƒê√£ c·∫≠p nh·∫≠t");
}
</script>

</body>
</html>
