<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>

body{
  font-family: Arial, sans-serif;
  background:#f3f6fb;
  padding:20px;
}
h1{text-align:center}

.container{
  display:flex;
  gap:24px;
  flex-wrap:wrap;
}
.box{
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  flex:1;
  min-width:320px;
}
.role-box{text-align:center}

select,input,textarea{
  width:100%;
  font-size:18px;
  padding:12px;
  margin-bottom:14px;
  border-radius:10px;
  border:2px solid #ddd;
}
.qty-input{
  width:80px;
  text-align:center;
  font-weight:bold;
}

button{
  border:none;
  border-radius:10px;
  background:#007bff;
  color:#fff;
  cursor:pointer;
  padding:6px 14px;
}
button:hover{background:#0056b3}

table{width:100%;border-collapse:collapse}
th{
  background:#007bff;
  color:white;
  padding:10px;
}
td{
  padding:10px;
  text-align:center;
  border-bottom:1px solid #eee;
}

.temp-import{background:#e8fff1}
.temp-export{background:#ffecec}

.history-group{
  background:#f0f4ff;
  cursor:pointer;
  font-weight:bold;
}
.history-group:hover{background:#dbe4ff}

.history-detail{
  background:#f9f9f9;
  padding:15px;
  border-left:4px solid #007bff;
}

.hidden{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- LOGIN -->
<div id="roleSelect" class="container">
  <div class="box role-box">
    <h2>ADMIN</h2>
    <input id="adminPass" type="password" placeholder="M·∫≠t kh·∫©u admin">
    <button onclick="loginAdmin()">ƒêƒÇNG NH·∫¨P</button>
  </div>

  <div class="box role-box">
    <h2>USER</h2>
    <button onclick="loginUser()">V√ÄO XEM</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminArea" class="hidden">
<div class="container">

<div class="box">
<h3>NH·∫¨P / XU·∫§T</h3>

<select id="itemCategory"></select>
<select id="itemSelect"></select>

<select id="sign">
<option value="+">NH·∫¨P</option>
<option value="-">XU·∫§T</option>
</select>

<input id="qty" type="number" class="qty-input" placeholder="SL">
<textarea id="noteLine" placeholder="Ghi ch√∫"></textarea>

<button onclick="addTemp()">Th√™m v√†o DS t·∫°m</button>
</div>

<div class="box">
<h3>DANH S√ÅCH T·∫†M</h3>
<table>
<thead>
<tr><th>V·∫≠t t∆∞</th><th>Lo·∫°i</th><th>Nh·∫≠p/Xu·∫•t</th><th>X√≥a</th></tr>
</thead>
<tbody id="tempTable"></tbody>
</table>

<button onclick="saveToSheet()">L∆∞u v√†o kho</button>
</div>

</div>
</div>

<!-- VIEW -->
<div id="viewArea" class="hidden">

<h3>V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>

<select id="categoryFilter" onchange="renderInventoryTable()">
<option value="all">-- T·∫§T C·∫¢ --</option>
</select>

<table>
<thead><tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th><th>Lo·∫°i</th></tr></thead>
<tbody id="mainTable"></tbody>
</table>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
<thead><tr><th>Th·ªùi gian</th><th>Chi ti·∫øt</th></tr></thead>
<tbody id="historyTable"></tbody>
</table>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyjRdZB6sndNCCT2QGg0rbG0-_ivOrFMOZ-HxwptKP4Nzne8c_CY74iHxTBwC8NePQaBg/exec";

let inventory=[],temp=[],history=[],isAdmin=false;

/* LOGIN */
function loginAdmin(){
  if(adminPass.value!=="1234") return alert("Sai m·∫≠t kh·∫©u");
  isAdmin=true;
  roleSelect.classList.add("hidden");
  adminArea.classList.remove("hidden");
  viewArea.classList.remove("hidden");
  init();
}
function loginUser(){
  roleSelect.classList.add("hidden");
  viewArea.classList.remove("hidden");
  init();
}

/* INIT */
async function init(){
  await loadInventory();
  await loadHistory();
}

/* LOAD */
async function loadInventory(){
  inventory=await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}
async function loadHistory(){
  history=await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

/* INVENTORY */
function renderInventory(){

  const categories=[...new Set(inventory.map(i=>i.category||"Kh√°c"))];

  categoryFilter.innerHTML=`<option value="all">-- T·∫§T C·∫¢ --</option>`;
  categories.forEach(c=>{
    categoryFilter.innerHTML+=`<option value="${c}">${c}</option>`;
  });

  if(isAdmin){
    itemCategory.innerHTML="";
    categories.forEach(c=>{
      itemCategory.innerHTML+=`<option value="${c}">${c}</option>`;
    });

    itemCategory.onchange=renderItemSelect;
    renderItemSelect();
  }

  renderInventoryTable();
}

function renderInventoryTable(){
  let filter=categoryFilter.value;
  mainTable.innerHTML="";
  inventory
    .filter(i=>filter==="all"||i.category===filter)
    .forEach(i=>{
      mainTable.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
        <td>${i.category}</td>
      </tr>`;
    });
}

function renderItemSelect(){
  let selectedCat=itemCategory.value;
  itemSelect.innerHTML="";
  inventory
    .filter(i=>i.category===selectedCat)
    .forEach(i=>{
      itemSelect.innerHTML+=`<option value="${inventory.indexOf(i)}">${i.name}</option>`;
    });
}

/* TEMP */
function addTemp(){
  const selected=inventory[itemSelect.value];
  temp.push({
    name:selected.name,
    category:selected.category,
    sign:sign.value,
    qty:+qty.value,
    note:noteLine.value
  });
  qty.value="";noteLine.value="";
  renderTemp();
}
function renderTemp(){
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
    <tr class="${t.sign==='+'?'temp-import':'temp-export'}">
      <td>${t.name}</td>
      <td>${t.category}</td>
      <td>${t.sign==='+'?'NH·∫¨P':'XU·∫§T'} ${t.qty}</td>
      <td><button onclick="temp.splice(${i},1);renderTemp()">X</button></td>
    </tr>`;
  });
}

/* SAVE */
async function saveToSheet(){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({items:temp})
  });
  temp=[];
  await init();
  alert("ƒê√£ l∆∞u");
}

/* =======================
   HISTORY
======================= */

function renderHistory(){
  historyTable.innerHTML = "";

  history.forEach((g, idx) => {

    if (!g.items || !g.items.length) return;

    // X√°c ƒë·ªãnh lo·∫°i (Nh·∫≠p / Xu·∫•t)
    const actionType = g.items[0].type || "";

    const actionLabel = actionType === "Nh·∫≠p"
      ? `<span style="color:green;font-weight:bold">NH·∫¨P</span>`
      : `<span style="color:red;font-weight:bold">XU·∫§T</span>`;

    // T·∫°o danh s√°ch v·∫≠t t∆∞ + s·ªë l∆∞·ª£ng
    const itemList = g.items
      .map(item => `${item.name} (${item.qty})`)
      .join(", ");

    const label = `${actionLabel}: ${itemList}`;

    historyTable.innerHTML += `
    <tr class="history-group" onclick="toggle(${idx})">
      <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
      <td>${label}</td>
    </tr>

    <tr id="h${idx}" style="display:none">
      <td colspan="2" class="history-detail">
        <table>
          <tr>
            <th>V·∫≠t t∆∞</th>
            <th>Lo·∫°i</th>
            <th>SL</th>
            <th>Ghi ch√∫</th>
          </tr>

          ${g.items.map((it, j) => `
          <tr>
            <td>${it.name}</td>
            <td>${it.category}</td>

            <td>
              ${
                isAdmin
                ? `<input class="qty-input"
                     value="${it.qty}"
                     onchange="history[${idx}].items[${j}].qty=+this.value">`
                : `<b>${it.qty}</b>`
              }
            </td>

            <td>
              ${
                isAdmin
                ? `<input
                     value="${it.note || ""}"
                     onchange="history[${idx}].items[${j}].note=this.value">`
                : (it.note || "")
              }
            </td>
          </tr>
          `).join("")}

          ${
            isAdmin
            ? `<tr>
                <td colspan="4">
                  <button onclick="saveHistory(${idx})">
                    L∆∞u ch·ªânh s·ª≠a
                  </button>
                </td>
              </tr>`
            : ``
          }

        </table>
      </td>
    </tr>`;
  });
}
function toggle(i){
  const el=document.getElementById("h"+i);
  el.style.display=el.style.display==="none"?"":"none";
}

async function saveHistory(i){
  if(!confirm("L∆∞u ch·ªânh s·ª≠a?"))return;
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"editHistory",group:history[i]})
  });
  await init();
  alert("ƒê√£ c·∫≠p nh·∫≠t");
}
</script>

</body>
</html>
