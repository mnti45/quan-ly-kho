<!DOCTYPE html><!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f3f6fb;
  padding:20px;
}

h1{text-align:center}

.container{
  display:flex;
  gap:24px;
  flex-wrap:wrap;
}

.box{
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  flex:1;
  min-width:320px;
}

/* LOGIN */
.role-box{
  text-align:center;
}
.role-box button{
  font-size:22px;
  padding:18px;
  margin-top:16px;
}

/* INPUT */
select,input,textarea{
  width:100%;
  font-size:20px;
  padding:14px;
  margin-bottom:14px;
  border-radius:10px;
  border:2px solid #ddd;
}
.qty-input{
  width:90px;
  text-align:center;
  font-weight:bold;
}
.note-textarea{
  resize:none;
}

/* BUTTON */
button{
  width:100%;
  padding:14px;
  font-size:20px;
  font-weight:bold;
  border:none;
  border-radius:10px;
  background:#007bff;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#0056b3}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}
th{
  background:#007bff;
  color:white;
  padding:12px;
}
td{
  padding:12px;
  text-align:center;
  border-bottom:1px solid #eee;
}

.temp-import{background:#e8fff1}
.temp-export{background:#ffecec}

.history-group{
  background:#f0f4ff;
  cursor:pointer;
  font-weight:bold;
}

/* ·∫®N */
.hidden{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- ================== CH·ªåN VAI TR√í ================== -->
<div id="roleSelect" class="container">
  <div class="box role-box">
    <h2> ADMIN</h2>
    <input id="adminPass" type="password" placeholder="M·∫≠t kh·∫©u admin">
    <button onclick="loginAdmin()">ƒêƒÇNG NH·∫¨P</button>
  </div>

  <div class="box role-box">
    <h2> USER</h2>
    <p>Xem v·∫≠t t∆∞ & l·ªãch s·ª≠ nh·∫≠p xu·∫•t</p>
    <button onclick="loginUser()">V√ÄO XEM</button>
  </div>
</div>

<!-- ================== ADMIN AREA ================== -->
<div id="adminArea" class="hidden">

<div class="container">

  <!-- NH·∫¨P / XU·∫§T -->
  <div class="box">
    <h3>üîÑ NH·∫¨P / XU·∫§T</h3>
    <select id="itemSelect"></select>
    <select id="sign">
      <option value="+">‚ûï NH·∫¨P</option>
      <option value="-">‚ûñ XU·∫§T</option>
    </select>
    <input id="qty" type="number" class="qty-input" placeholder="SL">
    <textarea id="noteLine" class="note-textarea" placeholder="Ghi ch√∫"></textarea>
    <button onclick="addTemp()">‚ûï TH√äM V√ÄO DANH S√ÅCH T·∫†M</button>
  </div>

  <!-- DANH S√ÅCH T·∫†M -->
  <div class="box">
    <h3>üìã DANH S√ÅCH T·∫†M</h3>
    <table>
      <thead>
        <tr>
          <th>V·∫≠t t∆∞</th>
          <th>Nh·∫≠p/Xu·∫•t</th>
          <th>Ghi ch√∫</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>
    <textarea id="logNote" class="note-textarea" placeholder="Ghi ch√∫ chung"></textarea>
    <button onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
  </div>

</div>

</div>

<!-- ================== USER + ADMIN CHUNG ================== -->
<div id="viewArea" class="hidden">

<h3> V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>
<table>
  <thead><tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
  <tbody id="mainTable"></tbody>
</table>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
  <thead>
    <tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxduYVlwx2reJLXTD-mvCHyKshrXZvHWxkK-gWcf6Iy74MRhheN4TwX2XLUzDD6rhMeMQ/exec";

let inventory=[],temp=[],history=[];
let isAdmin=false;

/* LOGIN */
function loginAdmin(){
  if(adminPass.value!=="1234") return alert("Sai m·∫≠t kh·∫©u");
  isAdmin=true;
  roleSelect.classList.add("hidden");
  adminArea.classList.remove("hidden");
  viewArea.classList.remove("hidden");
  init();
}

function loginUser(){
  isAdmin=false;
  roleSelect.classList.add("hidden");
  viewArea.classList.remove("hidden");
  init();
}

/* INIT */
async function init(){
  await loadInventory();
  await loadHistory();
}

/* INVENTORY */
function renderInventory(){
  if(isAdmin){
    itemSelect.innerHTML="";
    inventory.forEach((i,idx)=>{
      itemSelect.innerHTML+=`<option value="${idx}">${i.name}</option>`;
    });
  }

  mainTable.innerHTML="";
  inventory.forEach(i=>{
    mainTable.innerHTML+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

/* TEMP */
function renderTemp(){
  if(!isAdmin) return;
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
    <tr class="${t.sign==='+'?'temp-import':'temp-export'}">
      <td>${t.name}</td>
      <td>${t.sign==='+'?'NH·∫¨P':'XU·∫§T'}<br><b>${t.qty}</b></td>
      <td>${t.note||''}</td>
      <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
    </tr>`;
  });
}

/* HISTORY */
function renderHistory() {
  historyTable.innerHTML = "";

  history.forEach((g, idx) => {
    const detail = g.items.map(i => `${i.name}: ${i.qty}`).join(" | ");

    historyTable.innerHTML += `
      <tr class="history-group" onclick="toggle(${idx})">
        <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
        <td>${g.items[0].type}</td>
        <td>${detail}</td>
      </tr>

      <tr id="h${idx}" style="display:none">
        <td colspan="3">
          <table width="100%">
            <tr>
              <th>V·∫≠t t∆∞</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Ghi ch√∫</th>
            </tr>

            ${g.items.map((it,j)=>`
              <tr>
                <td>${it.name}</td>

                <td>
                  ${
                    isAdmin
                    ? `<input type="number" class="qty-input"
                        value="${it.qty}"
                        onchange="history[${idx}].items[${j}].qty = Number(this.value)">`
                    : `<b>${it.qty}</b>`
                  }
                </td>

                <td>
                  ${
                    isAdmin
                    ? `<textarea class="note-textarea"
                        onchange="history[${idx}].items[${j}].note = this.value">${it.note||""}</textarea>`
                    : (it.note || "")
                  }
                </td>
              </tr>
            `).join("")}

            ${
              isAdmin
              ? `<tr>
                  <td colspan="3">
                    <button onclick="saveHistory(${idx})">
                      üíæ L∆ØU CH·ªàNH S·ª¨A
                    </button>
                  </td>
                </tr>`
              : ``
            }

          </table>
        </td>
      </tr>
    `;
  });
}


function toggle(i){
  const el=document.getElementById("h"+i);
  el.style.display=el.style.display==="none"?"":"none";
}

/* LOAD */
async function loadInventory(){
  inventory=await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}
async function loadHistory(){
  history=await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

/* ACTION ADMIN */
function addTemp(){
  temp.push({
    name:inventory[itemSelect.value].name,
    sign:sign.value,
    qty:Number(qty.value),
    note:noteLine.value
  });
  qty.value="";noteLine.value="";
  renderTemp();
}

async function saveToSheet(){
  await fetch(API_URL,{method:"POST",body:JSON.stringify({items:temp,note:logNote.value})});
  temp=[];logNote.value="";
  await init();
  alert("ƒê√£ l∆∞u");
}
  async function saveHistory(index) {
  if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën ch·ªânh s·ª≠a l·ªãch s·ª≠ n√†y?")) return;

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "editHistory",
      group: history[index]
    })
  });

  await loadInventory();
  await loadHistory();

  alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t l·∫°i l·ªãch s·ª≠ & t·ªìn kho");
}

</script>

</body>
</html>




