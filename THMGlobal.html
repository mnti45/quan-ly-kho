<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>
body{
  font-family:Arial,sans-serif;
  padding:20px;
  background:#f3f6fb;
}
h1{margin-bottom:20px}
.container{display:flex;gap:24px;flex-wrap:wrap}
.box{
  flex:1;min-width:320px;background:#fff;
  padding:24px;border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1)
}

/* INPUT */
select,input,textarea{
  width:100%;font-size:20px;padding:14px;
  margin-bottom:14px;border-radius:10px;
  border:2px solid #ddd;resize:none
}
select:focus,input:focus,textarea:focus{
  border-color:#007bff;outline:none
}
.qty-input{width:90px;text-align:center;font-weight:bold}
.note-textarea{width:100%;min-height:44px;overflow:hidden}

/* BUTTON */
button{
  width:100%;padding:14px;font-size:20px;
  font-weight:bold;border:none;border-radius:10px;
  background:#007bff;color:#fff;cursor:pointer
}
button:hover{background:#0056b3}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:12px}
th{background:#007bff;color:#fff;padding:12px;font-size:18px}
td{
  padding:12px;font-size:18px;text-align:center;
  border-bottom:1px solid #eee;vertical-align:top
}

/* TEMP */
.temp-import{background:#e8fff1}
.temp-export{background:#ffecec}
.temp-action button{background:#dc3545;font-size:18px}
.temp-action button:hover{background:#b52a37}

/* HISTORY */
.history-group{background:#f0f4ff;cursor:pointer;font-weight:bold}
.history-detail{background:#fff}

/* ROLE */
.admin-only{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- LOGIN -->
<div id="loginBox" class="box" style="max-width:420px;margin:auto">
  <h3>üîê ƒêƒÇNG NH·∫¨P</h3>
  <input id="username" placeholder="T√†i kho·∫£n">
  <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
  <button onclick="login()">ƒêƒÇNG NH·∫¨P</button>
</div>

<!-- ADMIN -->
<div class="container admin-only">

  <div class="box">
    <h3>üîÑ NH·∫¨P / XU·∫§T</h3>
    <select id="itemSelect"></select>
    <select id="sign">
      <option value="+">‚ûï NH·∫¨P</option>
      <option value="-">‚ûñ XU·∫§T</option>
    </select>
    <input id="qty" type="number" class="qty-input" placeholder="SL">
    <textarea id="noteLine" class="note-textarea"
      placeholder="Ghi ch√∫ d√≤ng" oninput="autoResize(this)"></textarea>
    <button onclick="addTemp()">‚ûï TH√äM V√ÄO DANH S√ÅCH T·∫†M</button>
  </div>

  <div class="box">
    <h3>üìã DANH S√ÅCH T·∫†M</h3>
    <table>
      <thead>
        <tr>
          <th>V·∫≠t t∆∞</th>
          <th>Nh·∫≠p / Xu·∫•t</th>
          <th>Ghi ch√∫</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>

    <textarea id="logNote" class="note-textarea"
      placeholder="Ghi ch√∫ chung" oninput="autoResize(this)"></textarea>
    <button onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
  </div>
</div>

<hr>

<h3>üì¶ V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>
<table>
  <thead><tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr></thead>
  <tbody id="mainTable"></tbody>
</table>

<hr>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
  <thead>
    <tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>Chi ti·∫øt</th></tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxduYVlwx2reJLXTD-mvCHyKshrXZvHWxkK-gWcf6Iy74MRhheN4TwX2XLUzDD6rhMeMQ/exec";

let USER_ROLE="guest";
let inventory=[],temp=[],history=[];

function autoResize(el){
  el.style.height="auto";
  el.style.height=el.scrollHeight+"px";
}

/* LOGIN */
async function login(){
  const res=await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"login",
      username:username.value,
      password:password.value
    })
  }).then(r=>r.json());

  if(!res.success) return alert("‚ùå Sai t√†i kho·∫£n");

  USER_ROLE=res.role;
  loginBox.style.display="none";

  if(USER_ROLE==="admin"){
    document.querySelectorAll(".admin-only")
      .forEach(e=>e.style.display="flex");
  }

  loadInventory();
  loadHistory();
}

/* INVENTORY */
function renderInventory(){
  itemSelect.innerHTML="";
  mainTable.innerHTML="";
  inventory.forEach((i,idx)=>{
    itemSelect.innerHTML+=`<option value="${idx}">${i.name}</option>`;
    mainTable.innerHTML+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

/* TEMP */
function renderTemp(){
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
      <tr class="${t.sign==='+'?'temp-import':'temp-export'}">
        <td><b>${t.name}</b></td>
        <td>${t.sign==='+'?'‚ûï NH·∫¨P':'‚ûñ XU·∫§T'}<br><b>${t.qty}</b></td>
        <td>${t.note||''}</td>
        <td class="temp-action">
          <button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button>
        </td>
      </tr>`;
  });
}

/* HISTORY */
function renderHistory(){
  historyTable.innerHTML="";
  history.forEach((g,idx)=>{
    const detail=g.items.map(i=>`${i.name}:${i.qty}`).join(" | ");
    historyTable.innerHTML+=`
      <tr class="history-group" onclick="toggle(${idx})">
        <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
        <td>${g.items[0].type}</td>
        <td>${detail}</td>
      </tr>
      <tr id="h${idx}" style="display:none">
        <td colspan="3">
          <table width="100%">
            <tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th><th>Ghi ch√∫</th></tr>
            ${g.items.map((it,j)=>`
              <tr>
                <td>${it.name}</td>
                <td>${USER_ROLE==="admin"
                  ? `<input type="number" class="qty-input" value="${it.qty}"
                      onchange="history[${idx}].items[${j}].qty=Number(this.value)">`
                  : `<b>${it.qty}</b>`}
                </td>
                <td>${USER_ROLE==="admin"
                  ? `<textarea class="note-textarea" oninput="autoResize(this)"
                      onchange="history[${idx}].items[${j}].note=this.value">${it.note||""}</textarea>`
                  : (it.note||"")}
                </td>
              </tr>`).join("")}
            ${USER_ROLE==="admin"
              ? `<tr><td colspan="3">
                  <button onclick="saveHistory(${idx})">üíæ L∆ØU CH·ªàNH S·ª¨A</button>
                </td></tr>`
              : ""}
          </table>
        </td>
      </tr>`;
  });
}

function toggle(i){
  const el=document.getElementById("h"+i);
  el.style.display=el.style.display==="none"?"":"none";
}

/* LOAD */
async function loadInventory(){
  inventory=await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}
async function loadHistory(){
  history=await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

/* ACTION */
function addTemp(){
  if(qty.value<=0) return alert("Sai s·ªë l∆∞·ª£ng");
  temp.push({
    name:inventory[itemSelect.value].name,
    sign:sign.value,
    qty:Number(qty.value),
    note:noteLine.value
  });
  qty.value="";noteLine.value="";
  renderTemp();
}

async function saveToSheet(){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({items:temp,note:logNote.value})
  });
  temp=[];logNote.value="";
  loadInventory();loadHistory();
}

async function saveHistory(i){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"editHistory",group:history[i]})
  });
  loadInventory();loadHistory();
}
</script>

</body>
</html>
