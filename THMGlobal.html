<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>
body{
  font-family: Arial;
  background:#f3f6fb;
  padding:20px;
}
h1{margin-bottom:20px}

.box{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.1);
  margin-bottom:20px;
}

input,select,textarea,button{
  width:100%;
  padding:12px;
  font-size:18px;
  border-radius:8px;
  border:2px solid #ddd;
  margin-bottom:12px;
}

button{
  background:#007bff;
  color:#fff;
  font-weight:bold;
  border:none;
  cursor:pointer;
}
button:hover{background:#0056b3}

table{
  width:100%;
  border-collapse:collapse;
}
th{
  background:#007bff;
  color:#fff;
  padding:10px;
}
td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
}

.history-group{
  background:#eef3ff;
  cursor:pointer;
  font-weight:bold;
}

.hidden{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h3>üîê ƒêƒÇNG NH·∫¨P ADMIN</h3>
  <input id="user" placeholder="T√†i kho·∫£n">
  <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u">
  <button onclick="login()">ƒêƒÇNG NH·∫¨P</button>
</div>

<!-- NH·∫¨P XU·∫§T (ADMIN ONLY) -->
<div class="box hidden" id="adminBox">
  <h3>üîÑ NH·∫¨P / XU·∫§T</h3>

  <select id="itemSelect"></select>

  <select id="sign">
    <option value="+">‚ûï NH·∫¨P</option>
    <option value="-">‚ûñ XU·∫§T</option>
  </select>

  <input id="qty" type="number" placeholder="S·ªë l∆∞·ª£ng">

  <textarea id="noteLine" placeholder="Ghi ch√∫"></textarea>

  <button onclick="addTemp()">‚ûï TH√äM T·∫†M</button>

  <table>
    <thead>
      <tr>
        <th>V·∫≠t t∆∞</th>
        <th>Lo·∫°i</th>
        <th>SL</th>
        <th>X√≥a</th>
      </tr>
    </thead>
    <tbody id="tempTable"></tbody>
  </table>

  <button onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
</div>

<!-- T·ªíN KHO -->
<div class="box">
  <h3>üì¶ V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>
  <table>
    <thead>
      <tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr>
    </thead>
    <tbody id="mainTable"></tbody>
  </table>
</div>

<!-- HISTORY -->
<div class="box">
  <h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
  <table>
    <thead>
      <tr>
        <th>Th·ªùi gian</th>
        <th>Lo·∫°i</th>
        <th>Chi ti·∫øt</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxduYVlwx2reJLXTD-mvCHyKshrXZvHWxkK-gWcf6Iy74MRhheN4TwX2XLUzDD6rhMeMQ/exec";

let USER_ROLE = "guest";
let inventory=[], history=[], temp=[];

/* LOAD DATA CHO GUEST */
window.onload = ()=>{
  loadInventory();
  loadHistory();
};

/* LOGIN */
function login(){
  if(user.value==="admin" && pass.value==="123"){
    USER_ROLE="admin";
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
    alert("ƒêƒÉng nh·∫≠p ADMIN th√†nh c√¥ng");
  }else{
    alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
  }
}

/* INVENTORY */
async function loadInventory(){
  inventory = await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}

function renderInventory(){
  mainTable.innerHTML="";
  itemSelect.innerHTML="";
  inventory.forEach((i,idx)=>{
    mainTable.innerHTML+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
    if(USER_ROLE==="admin"){
      itemSelect.innerHTML+=`<option value="${idx}">${i.name}</option>`;
    }
  });
}

/* HISTORY */
async function loadHistory(){
  history = await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

function renderHistory(){
  historyTable.innerHTML="";
  history.forEach((g,idx)=>{
    historyTable.innerHTML+=`
      <tr class="history-group" onclick="toggle(${idx})">
        <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
        <td>${g.items[0].type}</td>
        <td>${g.items.map(i=>i.name+"("+i.qty+")").join(" | ")}</td>
      </tr>

      <tr id="h${idx}" class="hidden">
        <td colspan="3">
          <table width="100%">
            ${g.items.map((it,j)=>`
              <tr>
                <td>${it.name}</td>
                <td>
                  ${USER_ROLE==="admin"
                    ? `<input type="number" value="${it.qty}"
                      onchange="history[${idx}].items[${j}].qty=Number(this.value)">`
                    : `<b>${it.qty}</b>`
                  }
                </td>
                <td>
                  ${USER_ROLE==="admin"
                    ? `<input value="${it.note||""}"
                      onchange="history[${idx}].items[${j}].note=this.value">`
                    : (it.note||"")
                  }
                </td>
              </tr>
            `).join("")}

            ${USER_ROLE==="admin"
              ? `<tr><td colspan="3">
                   <button onclick="saveHistory(${idx})">üíæ L∆ØU CH·ªàNH S·ª¨A</button>
                 </td></tr>`
              : ""
            }
          </table>
        </td>
      </tr>
    `;
  });
}

function toggle(i){
  const el=document.getElementById("h"+i);
  el.classList.toggle("hidden");
}

/* TEMP + SAVE */
function addTemp(){
  if(qty.value<=0) return;
  temp.push({
    name: inventory[itemSelect.value].name,
    sign: sign.value,
    qty: Number(qty.value),
    note: noteLine.value
  });
  renderTemp();
}

function renderTemp(){
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
      <tr>
        <td>${t.name}</td>
        <td>${t.sign==="+"?"Nh·∫≠p":"Xu·∫•t"}</td>
        <td>${t.qty}</td>
        <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
      </tr>`;
  });
}

async function saveToSheet(){
  if(!temp.length) return;
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({items:temp})
  });
  temp=[];
  renderTemp();
  loadInventory();
  loadHistory();
}

/* EDIT HISTORY */
async function saveHistory(i){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"editHistory",
      group:history[i]
    })
  });
  loadInventory();
  loadHistory();
}
</script>

</body>
</html>
