<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>V·∫¨T T∆Ø KHO PH√ö M·ª∏</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f3f6fb;
  padding:20px;
}
h1{text-align:center}

.container{
  display:flex;
  gap:24px;
  flex-wrap:wrap;
}
.box{
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  flex:1;
  min-width:320px;
}
.role-box{text-align:center}
.role-box button{font-size:22px;padding:18px;margin-top:16px}

select,input,textarea{
  width:100%;
  font-size:18px;
  padding:12px;
  margin-bottom:14px;
  border-radius:10px;
  border:2px solid #ddd;
}
.qty-input{
  width:80px;
  text-align:center;
  font-weight:bold;
}
.note-textarea{resize:none}

button{
  border:none;
  border-radius:10px;
  background:#007bff;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#0056b3}
.btn-center{text-align:center}

.btn-compact{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 20px;
  font-size:15px;
  font-weight:600;
  border-radius:10px;
  background:#0d6efd;
  color:#fff;
  margin-top:10px;
}
.btn-compact:hover{background:#0b5ed7}

table{width:100%;border-collapse:collapse}
th{
  background:#007bff;
  color:white;
  padding:12px;
}
td{
  padding:12px;
  text-align:center;
  border-bottom:1px solid #eee;
}

.temp-import{background:#e8fff1}
.temp-export{background:#ffecec}

.hidden{display:none}
</style>
</head>

<body>

<h1>V·∫¨T T∆Ø KHO PH√ö M·ª∏</h1>

<!-- LOGIN -->
<div id="roleSelect" class="container">
  <div class="box role-box">
    <h2>ADMIN</h2>
    <input id="adminPass" type="password" placeholder="M·∫≠t kh·∫©u admin">
    <button class="btn-compact" onclick="loginAdmin()">ƒêƒÇNG NH·∫¨P</button>
  </div>

  <div class="box role-box">
    <h2>USER</h2>
    <p>Xem v·∫≠t t∆∞ & l·ªãch s·ª≠</p>
    <button class="btn-compact" onclick="loginUser()">V√ÄO XEM</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminArea" class="hidden">
<div class="container">

<div class="box">
<h3>üîÑ NH·∫¨P / XU·∫§T</h3>

<select id="itemCategory"></select>
<select id="itemSelect"></select>

<select id="sign">
<option value="+">‚ûï NH·∫¨P</option>
<option value="-">‚ûñ XU·∫§T</option>
</select>

<input id="qty" type="number" class="qty-input" placeholder="SL">
<textarea id="noteLine" placeholder="Ghi ch√∫"></textarea>

<div class="btn-center">
<button class="btn-compact" onclick="addTemp()">‚ûï Th√™m v√†o DS t·∫°m</button>
</div>
</div>

<div class="box">
<h3>üìã DANH S√ÅCH T·∫†M</h3>
<table>
<thead>
<tr><th>V·∫≠t t∆∞</th><th>Lo·∫°i</th><th>Nh·∫≠p/Xu·∫•t</th><th>X√≥a</th></tr>
</thead>
<tbody id="tempTable"></tbody>
</table>

<textarea id="logNote" placeholder="Ghi ch√∫ chung"></textarea>

<div class="btn-center">
<button class="btn-compact" onclick="saveToSheet()">üíæ L∆∞u v√†o kho</button>
</div>
</div>

</div>
</div>

<!-- VIEW -->
<div id="viewArea" class="hidden">

<h3>V·∫¨T T∆Ø HI·ªÜN T·∫†I</h3>

<select id="categoryFilter" onchange="renderInventoryTable()">
<option value="all">-- T·∫§T C·∫¢ --</option>
</select>

<table>
<thead><tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th><th>Lo·∫°i</th></tr></thead>
<tbody id="mainTable"></tbody>
</table>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzbJev1CRg98jCAKuoSGulU5FdPaReC4zWNAMHytX6Iw_u8C0dti4GK3Lxphfar62dLRQ/exec";

let inventory=[],temp=[],isAdmin=false;

/* LOGIN */
function loginAdmin(){
  if(adminPass.value!=="1234") return alert("Sai m·∫≠t kh·∫©u");
  isAdmin=true;
  roleSelect.classList.add("hidden");
  adminArea.classList.remove("hidden");
  viewArea.classList.remove("hidden");
  init();
}
function loginUser(){
  isAdmin=false;
  roleSelect.classList.add("hidden");
  viewArea.classList.remove("hidden");
  init();
}

/* INIT */
async function init(){
  await loadInventory();
}

/* LOAD INVENTORY */
async function loadInventory(){
  inventory=await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}

/* RENDER */
function renderInventory(){

  const categories=[...new Set(inventory.map(i=>i.category||"Kh√°c"))];

  // FILTER DROPDOWN
  categoryFilter.innerHTML=`<option value="all">-- T·∫§T C·∫¢ --</option>`;
  categories.forEach(c=>{
    categoryFilter.innerHTML+=`<option value="${c}">${c}</option>`;
  });

 if(isAdmin){

  itemCategory.innerHTML="";
  categories.forEach(c=>{
    itemCategory.innerHTML+=`<option value="${c}">${c}</option>`;
  });

  itemCategory.onchange=()=>{
    // üî• ƒê·ªìng b·ªô xu·ªëng b·∫£ng d∆∞·ªõi
    categoryFilter.value = itemCategory.value;

    renderItemSelect();
    renderInventoryTable();
  };

  renderItemSelect();
}

  let filter=categoryFilter.value;

  mainTable.innerHTML="";
  inventory
    .filter(i=>filter==="all"||i.category===filter)
    .forEach(i=>{
      mainTable.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
        <td>${i.category}</td>
      </tr>`;
    });
}

function renderItemSelect(){
  let selectedCat=itemCategory.value;
  itemSelect.innerHTML="";
  inventory
    .filter(i=>i.category===selectedCat)
    .forEach((i,idx)=>{
      itemSelect.innerHTML+=`<option value="${inventory.indexOf(i)}">${i.name}</option>`;
    });
}

/* TEMP */
function addTemp(){
  const selected=inventory[itemSelect.value];
  temp.push({
    name:selected.name,
    category:selected.category,
    sign:sign.value,
    qty:+qty.value
  });
  qty.value="";
  renderTemp();
}

function renderTemp(){
  tempTable.innerHTML="";
  temp.forEach((t,i)=>{
    tempTable.innerHTML+=`
    <tr class="${t.sign==='+'?'temp-import':'temp-export'}">
      <td>${t.name}</td>
      <td>${t.category}</td>
      <td>${t.sign==='+'?'NH·∫¨P':'XU·∫§T'} ${t.qty}</td>
      <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
    </tr>`;
  });
}

/* SAVE */
async function saveToSheet(){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({items:temp})
  });
  temp=[];
  await init();
  alert("ƒê√£ l∆∞u");
}
function renderInventoryTable(){
  let filter = categoryFilter.value;

  mainTable.innerHTML="";

  inventory
    .filter(i=>filter==="all"||i.category===filter)
    .forEach(i=>{
      mainTable.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
        <td>${i.category}</td>
      </tr>`;
    });
}
</script>

</body>
</html>
