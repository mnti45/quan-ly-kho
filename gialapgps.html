<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω v·∫≠t t∆∞</title>

<style>
body { font-family: Arial; padding: 20px; }
.container { display: flex; gap: 20px; }
.box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
input, select, button { width: 100%; padding: 6px; margin: 5px 0; }
button { cursor: pointer; }
tr.active { background: #ffeeba; }
</style>
</head>

<body>

<h1>üì¶ QU·∫¢N L√ù V·∫¨T T∆Ø</h1>

<!-- ===== T·ªíN KHO ===== -->
<h3>üìä T·ªìn kho</h3>
<table>
<thead>
<tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr>
</thead>
<tbody id="mainTable"></tbody>
</table>

<hr>

<!-- ===== NH·∫¨T K√ù ===== -->
<h3>üßæ L·ªãch s·ª≠ nh·∫≠p / xu·∫•t</h3>
<table>
<thead>
<tr>
  <th>V·∫≠t t∆∞</th>
  <th>Lo·∫°i</th>
  <th>SL</th>
  <th>Ghi ch√∫</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>

<h4>‚úèÔ∏è Ch·ªânh s·ª≠a d√≤ng ƒë√£ ch·ªçn</h4>
<input id="editQty" type="number" placeholder="S·ªë l∆∞·ª£ng">
<input id="editNote" placeholder="Ghi ch√∫">
<button onclick="saveEdit()">üíæ L∆∞u ch·ªânh s·ª≠a</button>

<script>
/* ================= API ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbz0C6y89gmcTOK3mtJt52UN9VJ9ZPe5TLPlERhRUE0dVgGuYUsSalLF43kca6xTmxbWfQ/exec";

/* ================= DATA ================= */
let inventory = [];
let logs = [];
let selectedLog = null;

/* ================= LOAD ================= */
async function loadAll() {
  try {
    const res = await fetch(API_URL + "?action=init");
    const data = await res.json();
    inventory = data.inventory;
    logs = data.logs;
    renderInventory();
    renderLogs();
  } catch (e) {
    alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Sheet");
    console.error(e);
  }
}

/* ================= RENDER ================= */
function renderInventory() {
  mainTable.innerHTML = "";
  inventory.forEach(i => {
    mainTable.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

function renderLogs() {
  logTable.innerHTML = "";
  logs.forEach((l, i) => {
    logTable.innerHTML += `
      <tr onclick="selectLog(${i})" class="${selectedLog===i?'active':''}">
        <td>${l.name}</td>
        <td>${l.type}</td>
        <td>${l.qty}</td>
        <td>${l.note}</td>
      </tr>
    `;
  });
}

/* ================= SELECT ================= */
function selectLog(i) {
  selectedLog = i;
  editQty.value = logs[i].qty;
  editNote.value = logs[i].note;
  renderLogs();
}

/* ================= SAVE EDIT ================= */
async function saveEdit() {
  if (selectedLog === null) {
    alert("Ch∆∞a ch·ªçn d√≤ng");
    return;
  }

  const log = logs[selectedLog];
  const newQty = Number(editQty.value);

  if (newQty <= 0) {
    alert("Sai s·ªë l∆∞·ª£ng");
    return;
  }

  try {
    await postToSheet({
      action: "editLog",
      id: log.id,
      qty: newQty,
      note: editNote.value
    });

    alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t ‚Äì kho t·ª± ƒëi·ªÅu ch·ªânh");
    loadAll();
    selectedLog = null;
  } catch (e) {
    alert("‚ùå L·ªói khi l∆∞u");
    console.error(e);
  }
}

/* ================= POST ================= */
async function postToSheet(payload) {
  const fd = new FormData();
  fd.append("data", JSON.stringify(payload));
  const res = await fetch(API_URL, { method: "POST", body: fd });
  return res.text();
}

/* ================= START ================= */
window.onload = loadAll;
</script>

</body>
</html>
