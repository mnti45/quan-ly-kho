<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω v·∫≠t t∆∞</title>

<style>
body { font-family: Arial; padding: 20px; }
.container { display: flex; gap: 20px; }
.box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
input, select, button { width: 100%; padding: 6px; margin: 5px 0; }
button { cursor: pointer; }
.small { font-size: 12px; color: #555; }
</style>
</head>

<body>

<h1>üì¶ QU·∫¢N L√ù V·∫¨T T∆Ø</h1>

<div class="container">
  <!-- ================= LEFT ================= -->
  <div class="box">
    <h3>‚ûï Th√™m v·∫≠t t∆∞ m·ªõi</h3>
    <input id="newName" placeholder="T√™n v·∫≠t t∆∞">
    <input id="newQty" type="number" placeholder="S·ªë l∆∞·ª£ng ban ƒë·∫ßu">
    <button onclick="addItem()">Th√™m v·∫≠t t∆∞</button>

    <hr>

    <h3>üîÑ Nh·∫≠p / Xu·∫•t</h3>
    <select id="itemSelect"></select>
    <select id="sign">
      <option value="+">Nh·∫≠p (+)</option>
      <option value="-">Xu·∫•t (-)</option>
    </select>
    <input id="qty" type="number" placeholder="S·ªë l∆∞·ª£ng">
    <input id="noteLine" placeholder="Ghi ch√∫ d√≤ng">
    <button onclick="addTemp()">‚ûï Th√™m t·∫°m</button>
  </div>

  <!-- ================= RIGHT ================= -->
  <div class="box">
    <h3>üìã Danh s√°ch t·∫°m (b·ªô nh·ªõ t·∫°m)</h3>
    <table>
      <thead>
        <tr>
          <th>V·∫≠t t∆∞</th>
          <th>SL</th>
          <th>Ghi ch√∫</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>

    <input id="logNote" placeholder="Ghi ch√∫ chung cho l·∫ßn nh·∫≠p / xu·∫•t n√†y">
    <button onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
  </div>
</div>

<hr>

<!-- ================= INVENTORY ================= -->
<h3>üìä T·ªíN KHO</h3>
<table>
  <thead>
    <tr>
      <th>V·∫≠t t∆∞</th>
      <th>S·ªë l∆∞·ª£ng</th>
    </tr>
  </thead>
  <tbody id="mainTable"></tbody>
</table>

<hr>

<!-- ================= HISTORY ================= -->
<h3>üïò L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
  <thead>
    <tr>
      <th>Th·ªùi gian</th>
      <th>Ghi ch√∫</th>
      <th>Chi ti·∫øt</th>
    </tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

<script>
/* ================== API ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbz0C6y89gmcTOK3mtJt52UN9VJ9ZPe5TLPlERhRUE0dVgGuYUsSalLF43kca6xTmxbWfQ/exec";

/* ================== DATA ================== */
let inventory = [];
let temp = [];
let historyLogs = [];

/* ================== LOAD ================== */
window.onload = async () => {
  await loadInventory();
  await loadHistory();
};

/* ================== RENDER ================== */
function render() {
  itemSelect.innerHTML = "";
  mainTable.innerHTML = "";
  tempTable.innerHTML = "";

  inventory.forEach(item => {
    itemSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
    mainTable.innerHTML += `
      <tr>
        <td>${item.name}</td>
        <td>${item.qty}</td>
      </tr>
    `;
  });

  temp.forEach((t, i) => {
    tempTable.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${t.sign}${t.qty}</td>
        <td>${t.note || ""}</td>
        <td><button onclick="removeTemp(${i})">‚ùå</button></td>
      </tr>
    `;
  });
}

function renderHistory() {
  historyTable.innerHTML = "";

  historyLogs.forEach(log => {
    const detail = log.items
      .map(i => `${i.name} (${i.sign}${i.qty})`)
      .join("<br>");

    historyTable.innerHTML += `
      <tr>
        <td>${log.time}</td>
        <td>${log.note || ""}</td>
        <td style="text-align:left">${detail}</td>
      </tr>
    `;
  });
}

/* ================== LOAD DATA ================== */
async function loadInventory() {
  const res = await fetch(API_URL + "?action=getInventory");
  inventory = await res.json();
  render();
}

async function loadHistory() {
  const res = await fetch(API_URL + "?action=getHistory");
  historyLogs = await res.json();
  renderHistory();
}

/* ================== POST ================== */
async function postToSheet(payload) {
  const fd = new FormData();
  fd.append("data", JSON.stringify(payload));
  await fetch(API_URL, { method: "POST", body: fd });
}

/* ================== ACTIONS ================== */
async function addItem() {
  const name = newName.value.trim();
  const qty = Number(newQty.value);
  if (!name || qty <= 0) return alert("Thi·∫øu d·ªØ li·ªáu");

  await postToSheet({
    action: "addItem",
    note: "Th√™m v·∫≠t t∆∞ m·ªõi",
    items: [{ name, sign: "+", qty }]
  });

  newName.value = "";
  newQty.value = "";

  await loadInventory();
  await loadHistory();
}

function addTemp() {
  const name = itemSelect.value;
  const q = Number(qty.value);
  if (q <= 0) return alert("Sai s·ªë l∆∞·ª£ng");

  temp.push({
    name,
    sign: sign.value,
    qty: q,
    note: noteLine.value
  });

  qty.value = "";
  noteLine.value = "";
  render();
}

function removeTemp(i) {
  temp.splice(i, 1);
  render();
}

async function saveToSheet() {
  if (temp.length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu");

  await postToSheet({
    action: "saveLog",
    note: logNote.value,
    items: temp
  });

  temp = [];
  logNote.value = "";

  await loadInventory();
  await loadHistory();

  alert("‚úÖ ƒê√£ l∆∞u v√† c·∫≠p nh·∫≠t kho");
}
</script>

</body>
</html>
