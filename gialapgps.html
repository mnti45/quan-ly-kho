
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω v·∫≠t t∆∞</title>

<style>
body { font-family: Arial; padding: 20px; }
.container { display: flex; gap: 20px; }
.box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
button { cursor: pointer; }
.history-group { background:#f6f6f6; cursor:pointer; }
.history-detail { background:#fffbe6; }
</style>
</head>

<body>

<h1>üì¶ QU·∫¢N L√ù V·∫¨T T∆Ø</h1>

<div class="container">
  <div class="box">
    <h3>üîÑ Nh·∫≠p / Xu·∫•t</h3>
    <select id="itemSelect"></select>
    <select id="sign">
      <option value="+">Nh·∫≠p (+)</option>
      <option value="-">Xu·∫•t (-)</option>
    </select>
    <input id="qty" type="number" placeholder="S·ªë l∆∞·ª£ng">
    <input id="noteLine" placeholder="Ghi ch√∫ d√≤ng">
    <button onclick="addTemp()">Th√™m t·∫°m</button>
  </div>

  <div class="box">
    <h3>üìã Danh s√°ch t·∫°m</h3>
    <table>
      <thead>
        <tr>
          <th>V·∫≠t t∆∞</th>
          <th>SL</th>
          <th>Ghi ch√∫</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>
    <input id="logNote" placeholder="Ghi ch√∫ chung">
    <button onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
  </div>
</div>

<hr>

<h3>üìä T·ªíN KHO</h3>
<table>
  <thead>
    <tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr>
  </thead>
  <tbody id="mainTable"></tbody>
</table>

<hr>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
  <thead>
    <tr><th>Th·ªùi gian</th><th>Chi ti·∫øt</th></tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyVTKhWtw4eHyr5jvOybX3588rWjMeHE9IQ1fylrELd0iq7cpC6lhnuMNqihXtgP5slEA/exec";

let inventory = [];
let temp = [];
let history = [];

window.onload = () => {
  loadInventory();
  loadHistory();
};

function renderInventory() {
  itemSelect.innerHTML = "";
  mainTable.innerHTML = "";
  inventory.forEach((i, idx) => {
    itemSelect.innerHTML += `<option value="${idx}">${i.name}</option>`;
    mainTable.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

function renderTemp() {
  tempTable.innerHTML = "";
  temp.forEach((t, i) => {
    tempTable.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${t.sign}${t.qty}</td>
        <td>${t.note}</td>
        <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
      </tr>`;
  });
}

function renderHistory() {
  historyTable.innerHTML = "";
  history.forEach((g, idx) => {
    historyTable.innerHTML += `
      <tr class="history-group" onclick="toggle(${idx})">
        <td>${g.time}</td>
        <td>${g.items.length} d√≤ng</td>
      </tr>
      <tr id="h${idx}" style="display:none">
        <td colspan="2">
          <table width="100%">
            ${g.items.map((i,j)=>`
              <tr class="history-detail">
                <td>${i.name}</td>
                <td>
                  <input type="number" value="${i.qty}"
                    onchange="history[${idx}].items[${j}].qty=this.value">
                </td>
                <td>${i.sign}</td>
              </tr>`).join("")}
            <tr>
              <td colspan="3">
                <button onclick="saveHistory(${idx})">üíæ L∆∞u ch·ªânh s·ª≠a</button>
              </td>
            </tr>
          </table>
        </td>
      </tr>`;
  });
}

function toggle(i){
  const el = document.getElementById("h"+i);
  el.style.display = el.style.display==="none"?"":"none";
}

async function loadInventory(){
  inventory = await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}

async function loadHistory(){
  history = await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

function addTemp(){
  const idx = itemSelect.value;
  if(qty.value<=0) return alert("Sai s·ªë l∆∞·ª£ng");
  temp.push({
    name: inventory[idx].name,
    sign: sign.value,
    qty: Number(qty.value),
    note: noteLine.value
  });
  qty.value=""; noteLine.value="";
  renderTemp();
}

async function saveToSheet(){
  if(!temp.length) return;
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({note:logNote.value,items:temp})
  });
  temp=[]; logNote.value="";
  await loadInventory();
  await loadHistory();
  alert("‚úÖ ƒê√£ l∆∞u & c·∫≠p nh·∫≠t l·ªãch s·ª≠");
}

async function saveHistory(i){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"editHistory",group:history[i]})
  });
  await loadInventory();
  await loadHistory();
  alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t l·∫°i kho");
}
</script>

</body>
</html>



