<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω v·∫≠t t∆∞</title>

<style>
body { font-family: Arial; padding: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
input, select, button { padding: 6px; }
button { cursor: pointer; }
.box { border: 1px solid #ccc; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
.edit { background: #fffbe6; width: 80px; }
</style>
</head>

<body>

<h1>üì¶ QU·∫¢N L√ù V·∫¨T T∆Ø</h1>

<!-- ================== T·ªíN KHO ================== -->
<div class="box">
<h3>üìä T·ªíN KHO (ch·ªâ xem)</h3>
<table>
<thead>
<tr>
<th>V·∫≠t t∆∞</th>
<th>S·ªë l∆∞·ª£ng</th>
</tr>
</thead>
<tbody id="inventoryTable"></tbody>
</table>
</div>

<!-- ================== L·ªäCH S·ª¨ ================== -->
<div class="box">
<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T (c√≥ th·ªÉ ch·ªânh s·ª≠a)</h3>
<table>
<thead>
<tr>
<th>Th·ªùi gian</th>
<th>V·∫≠t t∆∞</th>
<th>Lo·∫°i</th>
<th>S·ªë l∆∞·ª£ng</th>
<th>L∆∞u</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>
</div>

<script>
/* ================== API ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbz0C6y89gmcTOK3mtJt52UN9VJ9ZPe5TLPlERhRUE0dVgGuYUsSalLF43kca6xTmxbWfQ/exec";

let inventory = [];
let logs = [];

/* ================== LOAD ================== */
window.onload = async () => {
  await loadInventory();
  await loadLogs();
};

/* ================== LOAD T·ªíN KHO ================== */
async function loadInventory() {
  const res = await fetch(API_URL + "?action=getInventory");
  inventory = await res.json();

  inventoryTable.innerHTML = "";
  inventory.forEach(i => {
    inventoryTable.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
      </tr>
    `;
  });
}

/* ================== LOAD NH·∫¨T K√ù ================== */
async function loadLogs() {
  const res = await fetch(API_URL + "?action=getLogs");
  logs = await res.json();

  logTable.innerHTML = "";
  logs.forEach((l, i) => {
    logTable.innerHTML += `
      <tr>
        <td>${new Date(l.time).toLocaleString()}</td>
        <td>${l.name}</td>
        <td>
          <select onchange="logs[${i}].type=this.value">
            <option value="+" ${l.type==="+"?"selected":""}>Nh·∫≠p</option>
            <option value="-" ${l.type==="-"?"selected":""}>Xu·∫•t</option>
          </select>
        </td>
        <td>
          <input class="edit" type="number" value="${l.qty}"
            onchange="logs[${i}].newQty=Number(this.value)">
        </td>
        <td>
          <button onclick="saveLog(${i})">üíæ</button>
        </td>
      </tr>
    `;
  });
}

/* ================== L∆ØU S·ª¨A NH·∫¨T K√ù ================== */
async function saveLog(i) {
  const log = logs[i];
  const oldQty = log.qty;
  const newQty = log.newQty ?? log.qty;

  const delta = (log.type === "+" ? 1 : -1) * (newQty - oldQty);

  await post({
    action: "editLog",
    name: log.name,
    delta: delta,
    oldQty: oldQty,
    newQty: newQty,
    type: log.type,
    time: log.time
  });

  alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t");

  await loadInventory();
  await loadLogs();
}

/* ================== POST ================== */
async function post(payload) {
  const formData = new FormData();
  formData.append("data", JSON.stringify(payload));

  await fetch(API_URL, {
    method: "POST",
    body: formData
  });
}
</script>

</body>
</html>
