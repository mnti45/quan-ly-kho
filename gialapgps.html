<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quáº£n lÃ½ váº­t tÆ°</title>

<style>
body { font-family: Arial; padding: 20px; }
.container { display: flex; gap: 20px; }
.box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
.group { border: 1px solid #aaa; margin: 10px 0; padding: 10px; }
.group h4 { margin: 0 0 5px; }
.editable { background: #fffbe6; }
</style>
</head>

<body>

<h1>ğŸ“¦ QUáº¢N LÃ Váº¬T TÆ¯</h1>

<!-- ===== NHáº¬P / XUáº¤T ===== -->
<div class="container">
  <div class="box">
    <h3>ğŸ”„ Nháº­p / Xuáº¥t (Bá»™ nhá»› táº¡m)</h3>
    <select id="itemSelect"></select>
    <select id="sign">
      <option value="+">Nháº­p (+)</option>
      <option value="-">Xuáº¥t (-)</option>
    </select>
    <input id="qty" type="number" placeholder="Sá»‘ lÆ°á»£ng">
    <input id="noteLine" placeholder="Ghi chÃº">
    <button onclick="addTemp()">ThÃªm táº¡m</button>
  </div>

  <div class="box">
    <h3>ğŸ“‹ Nhá»› táº¡m</h3>
    <table>
      <thead>
        <tr><th>VT</th><th>SL</th><th>Note</th><th></th></tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>
    <input id="logNote" placeholder="Ghi chÃº nhÃ³m">
    <button onclick="saveGroup()">ğŸ’¾ LÆ¯U NHÃ“M</button>
  </div>
</div>

<hr>

<!-- ===== Tá»’N KHO ===== -->
<h3>ğŸ“Š Tá»“n kho</h3>
<table>
<thead><tr><th>Váº­t tÆ°</th><th>Sá»‘ lÆ°á»£ng</th></tr></thead>
<tbody id="mainTable"></tbody>
</table>

<hr>

<!-- ===== Lá»ŠCH Sá»¬ ===== -->
<h3>ğŸ•’ Lá»‹ch sá»­ nháº­p / xuáº¥t</h3>
<div id="historyBox"></div>

<script>
const API_URL = "YOUR_WEB_APP_URL";

/* ===== DATA ===== */
let inventory = [];
let temp = [];
let history = [];

/* ===== LOAD ===== */
window.onload = async () => {
  await loadInventory();
  await loadHistory();
};

/* ===== INVENTORY ===== */
async function loadInventory() {
  inventory = await (await fetch(API_URL + "?action=getInventory")).json();
  renderInventory();
}

function renderInventory() {
  mainTable.innerHTML = "";
  itemSelect.innerHTML = "";
  inventory.forEach((i, idx) => {
    itemSelect.innerHTML += `<option value="${idx}">${i.name}</option>`;
    mainTable.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

/* ===== TEMP ===== */
function addTemp() {
  const idx = itemSelect.value;
  temp.push({
    name: inventory[idx].name,
    sign: sign.value,
    qty: Number(qty.value),
    note: noteLine.value
  });
  qty.value = noteLine.value = "";
  renderTemp();
}

function renderTemp() {
  tempTable.innerHTML = "";
  temp.forEach((t, i) => {
    tempTable.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${t.sign}${t.qty}</td>
        <td>${t.note}</td>
        <td><button onclick="temp.splice(${i},1);renderTemp()">âŒ</button></td>
      </tr>`;
  });
}

/* ===== SAVE GROUP ===== */
async function saveGroup() {
  const groupId = Date.now();
  await post({
    action: "saveGroup",
    groupId,
    note: logNote.value,
    items: temp
  });
  temp = [];
  logNote.value = "";
  await loadInventory();
  await loadHistory();
}

/* ===== HISTORY ===== */
async function loadHistory() {
  history = await (await fetch(API_URL + "?action=getHistory")).json();
  renderHistory();
}

function renderHistory() {
  historyBox.innerHTML = "";
  history.forEach(g => {
    historyBox.innerHTML += `
      <div class="group">
        <h4>ğŸ•’ ${new Date(g.time).toLocaleString()}</h4>
        ${g.items.map((i, idx) => `
          <div>
            ${i.name}
            <select onchange="i.sign=this.value">
              <option ${i.sign==='+'?'selected':''}>+</option>
              <option ${i.sign==='-'?'selected':''}>-</option>
            </select>
            <input class="editable" type="number" value="${i.qty}"
              onchange="i.qty=Number(this.value)">
          </div>
        `).join("")}
        <button onclick="updateHistory('${g.groupId}')">ğŸ’¾ Cáº­p nháº­t</button>
      </div>`;
  });
}

/* ===== UPDATE HISTORY ===== */
async function updateHistory(groupId) {
  const g = history.find(x => x.groupId === groupId);
  await post({ action: "updateHistory", groupId, items: g.items });
  await loadInventory();
  await loadHistory();
}

/* ===== POST ===== */
async function post(data) {
  const fd = new FormData();
  fd.append("data", JSON.stringify(data));
  await fetch(API_URL, { method: "POST", body: fd });
}
</script>

</body>
</html>
