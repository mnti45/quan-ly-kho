<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω v·∫≠t t∆∞</title>

<style>
body { font-family: Arial; padding: 20px; background:#fafafa; }
.container { display: flex; gap: 20px; }
.box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background:#fff; }

h3 { margin-top: 0; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #eee; }

button { cursor: pointer; padding:8px 12px; border-radius:6px; border:none; }

input, select {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  margin-top: 6px;
}

/* ====== NH·∫¨P / XU·∫§T BUTTON ====== */
.type-box {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.type-btn {
  flex: 1;
  font-size: 18px;
  font-weight: bold;
  padding: 15px 0;
  border-radius: 10px;
  opacity: 0.4;
}

.type-btn.active {
  opacity: 1;
}

.type-in {
  background: #d4f8d4;
  color: #006400;
}

.type-out {
  background: #ffd6d6;
  color: #8b0000;
}

/* ====== TEMP LIST ====== */
.badge-in {
  background:#d4f8d4;
  color:#006400;
  padding:4px 8px;
  border-radius:6px;
  font-weight:bold;
}

.badge-out {
  background:#ffd6d6;
  color:#8b0000;
  padding:4px 8px;
  border-radius:6px;
  font-weight:bold;
}

.qty {
  font-weight:bold;
  font-size:18px;
}

/* ====== HISTORY ====== */
.history-group { background:#f6f6f6; cursor:pointer; }
.history-detail { background:#fffbe6; }

</style>
</head>

<body>

<h1>üì¶ QU·∫¢N L√ù V·∫¨T T∆Ø</h1>

<div class="container">
  <div class="box">
    <h3>üîÑ Nh·∫≠p / Xu·∫•t</h3>

    <select id="itemSelect"></select>

    <!-- BUTTON NH·∫¨P XU·∫§T -->
    <div class="type-box">
      <button class="type-btn type-in active" onclick="setType('+')">‚¨ÜÔ∏è NH·∫¨P</button>
      <button class="type-btn type-out" onclick="setType('-')">‚¨áÔ∏è XU·∫§T</button>
    </div>

    <input id="qty" type="number" placeholder="S·ªë l∆∞·ª£ng">
    <input id="noteLine" placeholder="Ghi ch√∫ d√≤ng">
    <button style="margin-top:10px;background:#007bff;color:#fff" onclick="addTemp()">‚ûï Th√™m v√†o danh s√°ch t·∫°m</button>
  </div>

  <div class="box">
    <h3>üìã Danh s√°ch t·∫°m</h3>

    <table>
      <thead>
        <tr>
          <th>V·∫≠t t∆∞</th>
          <th>Lo·∫°i</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Ghi ch√∫</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="tempTable"></tbody>
    </table>

    <input id="logNote" placeholder="Ghi ch√∫ chung">
    <button style="margin-top:10px;background:#28a745;color:#fff" onclick="saveToSheet()">üíæ L∆ØU V√ÄO KHO</button>
  </div>
</div>

<hr>

<h3>üìä T·ªíN KHO</h3>
<table>
  <thead>
    <tr><th>V·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng</th></tr>
  </thead>
  <tbody id="mainTable"></tbody>
</table>

<hr>

<h3>üïí L·ªäCH S·ª¨ NH·∫¨P / XU·∫§T</h3>
<table>
  <thead>
    <tr>
      <th>Th·ªùi gian</th>
      <th>Nh·∫≠p / Xu·∫•t</th>
      <th>Chi ti·∫øt</th>
    </tr>
  </thead>
  <tbody id="historyTable"></tbody>
</table>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxduYVlwx2reJLXTD-mvCHyKshrXZvHWxkK-gWcf6Iy74MRhheN4TwX2XLUzDD6rhMeMQ/exec";

let inventory = [];
let temp = [];
let history = [];
let currentSign = "+"; // M·∫∂C ƒê·ªäNH NH·∫¨P

window.onload = () => {
  loadInventory();
  loadHistory();
};

/* ===== TYPE ===== */
function setType(sign){
  currentSign = sign;
  document.querySelectorAll(".type-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(sign==="+"?".type-in":".type-out").classList.add("active");
}

/* ===== INVENTORY ===== */
function renderInventory() {
  itemSelect.innerHTML = "";
  mainTable.innerHTML = "";
  inventory.forEach((i, idx) => {
    itemSelect.innerHTML += `<option value="${idx}">${i.name}</option>`;
    mainTable.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td></tr>`;
  });
}

/* ===== TEMP ===== */
function renderTemp() {
  tempTable.innerHTML = "";
  temp.forEach((t, i) => {
    tempTable.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${t.sign==="+" ? `<span class="badge-in">NH·∫¨P</span>` : `<span class="badge-out">XU·∫§T</span>`}</td>
        <td class="qty">${t.qty}</td>
        <td>${t.note || ""}</td>
        <td><button onclick="temp.splice(${i},1);renderTemp()">‚ùå</button></td>
      </tr>`;
  });
}

/* ===== HISTORY ===== */
function renderHistory() {
  historyTable.innerHTML = "";
  history.forEach(g => {
    const detail = g.items.map(i=>i.note).filter(Boolean).join(" | ");
    historyTable.innerHTML += `
      <tr>
        <td>${new Date(g.time).toLocaleString("vi-VN")}</td>
        <td>${g.items[0].type}</td>
        <td>${detail}</td>
      </tr>`;
  });
}

/* ===== LOAD ===== */
async function loadInventory(){
  inventory = await fetch(API_URL+"?action=getInventory").then(r=>r.json());
  renderInventory();
}

async function loadHistory(){
  history = await fetch(API_URL+"?action=getHistory").then(r=>r.json());
  renderHistory();
}

/* ===== ACTION ===== */
function addTemp(){
  const idx = itemSelect.value;
  if(qty.value<=0) return alert("Sai s·ªë l∆∞·ª£ng");

  temp.push({
    name: inventory[idx].name,
    sign: currentSign,
    qty: Number(qty.value),
    note: noteLine.value
  });

  qty.value=""; noteLine.value="";
  renderTemp();
}

async function saveToSheet(){
  if(!temp.length) return;

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      type: currentSign==="+"?"Nh·∫≠p":"Xu·∫•t",
      note: logNote.value,
      items: temp
    })
  });

  temp=[];
  logNote.value="";
  await loadInventory();
  await loadHistory();
  alert("‚úÖ ƒê√£ l∆∞u & c·∫≠p nh·∫≠t kho");
}
</script>

</body>
</html>
